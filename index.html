<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mec√°nica CataRomero ‚Äî Panel Chatbot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* =======================
       THEMES (LIGHT / DARK)
       ======================= */
    :root {
      --transition-fast: 0.15s ease-out;
      --radius-md: 12px;
      --radius-lg: 18px;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.25);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* Theme DARK (por defecto) */
    :root[data-theme="dark"] {
      --bg: #020617;
      --bg-soft: #020617;
      --bg-soft-2: #0b1220;
      --surface: #020617;
      --card: #020617;
      --card-alt: #020617;
      --primary: #22c55e;
      --primary-soft: rgba(34, 197, 94, 0.16);
      --accent: #22c55e;
      --accent-soft: rgba(244, 114, 182, 0.18);
      --border: #1e293b;
      --text: #f9fafb;
      --muted: #9ca3af;
      --muted-strong: #e5e7eb;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
    }

    /* Theme LIGHT */
    :root[data-theme="light"] {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --bg-soft-2: #e5e7eb;
      --surface: #ffffff;
      --card: #ffffff;
      --card-alt: #f9fafb;
      --primary: #16a34a;
      --primary-soft: rgba(22, 163, 74, 0.14);
      --accent: #22c55e;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --border: #d1d5db;
      --text: #111827;
      --muted: #6b7280;
      --muted-strong: #111827;
      --danger: #b91c1c;
      --danger-soft: rgba(185, 28, 28, 0.12);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background:
        radial-gradient(900px circle at 0% 0%, rgba(34, 197, 94, 0.25), transparent 55%),
        radial-gradient(1100px circle at 100% 0%, rgba(56, 189, 248, 0.20), transparent 60%),
        radial-gradient(1200px circle at 50% 120%, rgba(15, 23, 42, 0.9), transparent 80%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .layout {
      display: grid;
      grid-template-columns: 270px 1fr;
      min-height: 100vh;
      backdrop-filter: blur(10px);
    }

    /* =======================
       SIDEBAR
       ======================= */
    aside {
      border-right: 1px solid var(--border);
      padding: 1rem 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.7rem 0.8rem;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.4), transparent 60%),
                  linear-gradient(120deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.6);
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 0 0, #22c55e, #0f766e);
      color: #022c22;
      font-weight: 900;
      letter-spacing: 0.05em;
      font-size: 0.85rem;
    }

    .brand h1 {
      font-size: 1rem;
      font-weight: 800;
    }

    .brand small {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .nav button {
      border: none;
      background: transparent;
      color: var(--muted);
      text-align: left;
      padding: 0.65rem 0.7rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background var(--transition-fast), color var(--transition-fast), transform 0.1s;
      font-size: 0.9rem;
    }

    .nav button span.label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .nav button .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--muted);
    }

    .nav button.active {
      background: var(--primary-soft);
      color: var(--primary);
      transform: translateX(2px);
    }

    .nav button:hover {
      background: rgba(148, 163, 184, 0.12);
      color: var(--muted-strong);
    }

    .nav .badge {
      background: rgba(148, 163, 184, 0.2);
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
    }

    .side-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .wsp-btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 0.65rem 0.9rem;
      border-radius: 999px;
      background: #22c55e;
      color: #052e16;
      text-decoration: none;
      font-weight: 800;
      font-size: 0.9rem;
      box-shadow: 0 10px 24px rgba(34, 197, 94, 0.65);
    }

    .side-note {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
    }

    /* =======================
       MAIN + TOPBAR
       ======================= */
    main {
      padding: 1rem 1.4rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .topbar {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      box-shadow: var(--shadow-soft);
    }

    .search {
      flex: 1;
      padding: 0.55rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.65);
      color: var(--text);
      outline: none;
      font-size: 0.9rem;
    }

    .search::placeholder {
      color: var(--muted);
    }

    .top-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn {
      border: 1px solid rgba(148, 163, 184, 0.5);
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.5);
      color: var(--text);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: background var(--transition-fast), transform 0.1s, border-color var(--transition-fast);
    }

    .btn:hover {
      background: rgba(148, 163, 184, 0.18);
      transform: translateY(-1px);
    }

    .btn.primary {
      background: var(--primary);
      border-color: transparent;
      color: #022c22;
    }

    .btn.primary:hover {
      background: #16a34a;
    }

    .btn.danger {
      background: var(--danger);
      border-color: transparent;
      color: #fef2f2;
    }

    .btn.pill {
      border-radius: 999px;
    }

    /* Toggle theme */
    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .theme-toggle input {
      appearance: none;
      width: 36px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      position: relative;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.6);
    }

    .theme-toggle input::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #e5e7eb;
      top: 1px;
      left: 2px;
      transition: transform var(--transition-fast);
    }

    .theme-toggle input:checked::after {
      transform: translateX(16px);
    }

    /* =======================
       SECTION & CARDS
       ======================= */
    .section {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }

    .section.visible {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.95rem 1rem;
      box-shadow: var(--shadow-soft);
    }

    :root[data-theme="light"] .card {
      background: linear-gradient(160deg, #ffffff, #f9fafb);
      border-color: #d1d5db;
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.6rem;
    }

    .card-head h3 {
      font-size: 0.95rem;
      font-weight: 800;
    }

    .pill {
      font-size: 0.75rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 700;
    }

    .pill.soft {
      background: rgba(148, 163, 184, 0.2);
      color: var(--muted-strong);
    }

    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 0.8rem;
    }

    .kpi {
      padding: 0.8rem 0.9rem;
      border-radius: 14px;
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.25), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    :root[data-theme="light"] .kpi {
      background: linear-gradient(135deg, #ffffff, #f9fafb);
      border-color: #d1d5db;
    }

    .kpi .label {
      font-size: 0.78rem;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .kpi .value {
      font-size: 1.5rem;
      font-weight: 900;
    }

    .kpi .sub {
      font-size: 0.75rem;
      color: var(--muted);
    }

    /* grids */
    .grid-3 {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 1fr;
      gap: 1rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 1rem;
    }

    /* tables */
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.75);
    }

    :root[data-theme="light"] .table-wrap {
      background: #ffffff;
      border-color: #d1d5db;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 720px;
    }

    th, td {
      padding: 0.55rem 0.6rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      white-space: nowrap;
    }

    th {
      color: var(--muted);
      font-weight: 700;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(15, 23, 42, 0.9);
    }

    :root[data-theme="light"] th {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: rgba(148, 163, 184, 0.12);
      cursor: pointer;
    }

    .st {
      font-size: 0.7rem;
      font-weight: 800;
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
    }

    .st.ok { background: rgba(34, 197, 94, 0.18); color: #4ade80; }
    .st.alert { background: var(--danger-soft); color: var(--danger); }
    .st.rev { background: var(--accent-soft); color: var(--accent); }

    /* forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text);
      padding: 0.45rem 0.6rem;
      outline: none;
      font-size: 0.85rem;
    }

    :root[data-theme="light"] .field input,
    :root[data-theme="light"] .field select,
    :root[data-theme="light"] .field textarea {
      background: #f9fafb;
      border-color: #d1d5db;
      color: var(--text);
    }

    .field textarea {
      min-height: 70px;
      resize: vertical;
    }

    .form-actions {
      margin-top: 0.65rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .empty {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--muted);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 10px;
      padding: 0.6rem;
      text-align: center;
      background: rgba(15, 23, 42, 0.6);
    }

    /* charts */
    .chart-box {
      height: 220px;
    }

    /* responsive */
    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: 230px 1fr;
      }
      .kpi-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .grid-3, .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      aside {
        position: sticky;
        top: 0;
        z-index: 5;
        flex-direction: row;
        overflow-x: auto;
        height: auto;
      }
      .brand {
        min-width: 200px;
      }
      .nav {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .nav button {
        white-space: nowrap;
      }
    }

    @media (max-width: 720px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .topbar {
        flex-direction: column;
        align-items: stretch;
      }
      .top-actions {
        justify-content: flex-end;
        flex-wrap: wrap;
      }
    }
  </style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside>
    <div class="brand">
      <div class="logo">MC</div>
      <div>
        <h1>Mec√°nica CataRomero</h1>
        <small>Panel del Chatbot</small>
      </div>
    </div>

    <div class="nav">
      <button class="active" data-section="overview">
        <span class="label"><span class="dot"></span> Overview</span>
      </button>
      <button data-section="reports">
        <span class="label"><span class="dot"></span> Informes Chatbot</span>
        <span class="badge" id="b-reports">0</span>
      </button>
      <button data-section="appointments">
        <span class="label"><span class="dot"></span> Citas / Agenda</span>
        <span class="badge" id="b-appointments">0</span>
      </button>
      <button data-section="store">
        <span class="label"><span class="dot"></span> Tienda / Productos</span>
      </button>
      <button data-section="quotes">
        <span class="label"><span class="dot"></span> Cotizaciones</span>
        <span class="badge" id="b-quotes">0</span>
      </button>
      <button data-section="invoices">
        <span class="label"><span class="dot"></span> Facturas</span>
        <span class="badge" id="b-invoices">0</span>
      </button>
      <button data-section="clients">
        <span class="label"><span class="dot"></span> Clientes</span>
      </button>
      <button data-section="vehicles">
        <span class="label"><span class="dot"></span> Veh√≠culos</span>
      </button>
      <button data-section="settings">
        <span class="label"><span class="dot"></span> Configuraci√≥n</span>
      </button>
    </div>

    <div class="side-footer">
      <a id="globalWspBtn" class="wsp-btn" target="_blank" rel="noopener">
        Abrir chatbot WhatsApp
      </a>
      <p class="side-note">
        Conectado al flujo de WhatsApp: informes, citas, cotizaciones y m√°s.
      </p>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <!-- TOPBAR -->
    <div class="topbar">
      <input id="globalSearch" class="search" placeholder="Buscar patente, cliente, tel√©fono, folio, etc." />

      <div class="top-actions">
        <button class="btn pill" id="rangeToday">Hoy</button>
        <button class="btn pill" id="range7d">7 d√≠as</button>
        <button class="btn pill" id="range30d">30 d√≠as</button>
        <button class="btn primary pill" id="btnNewAppointment">+ Nueva cita</button>

        <label class="theme-toggle">
          <span>‚òÄÔ∏è</span>
          <input type="checkbox" id="themeSwitch" />
          <span>üåô</span>
        </label>
      </div>
    </div>

    <!-- OVERVIEW -->
    <section id="overview" class="section visible">
      <div class="kpi-grid">
        <div class="kpi">
          <div class="label">Informes Totales</div>
          <div class="value" id="k-total">0</div>
          <div class="sub">Generados por el chatbot</div>
        </div>
        <div class="kpi">
          <div class="label">Informes OK</div>
          <div class="value" id="k-ok">0</div>
          <div class="sub">Dentro de par√°metros</div>
        </div>
        <div class="kpi">
          <div class="label">Alertas</div>
          <div class="value" id="k-alert">0</div>
          <div class="sub">Componentes con riesgo</div>
        </div>
        <div class="kpi">
          <div class="label">Citas pr√≥ximas</div>
          <div class="value" id="k-appt">0</div>
          <div class="sub">Agendadas desde WhatsApp</div>
        </div>
        <div class="kpi">
          <div class="label">Cotizaciones Pend.</div>
          <div class="value" id="k-quotes">0</div>
          <div class="sub">En espera de respuesta</div>
        </div>
        <div class="kpi">
          <div class="label">Ventas Mes (CLP)</div>
          <div class="value" id="k-sales">$0</div>
          <div class="sub">Facturas registradas</div>
        </div>
      </div>

      <div class="grid-3" style="margin-top: 1rem;">
        <div class="card">
          <div class="card-head">
            <h3>Distribuci√≥n: OK vs Alertas</h3>
            <span class="pill soft">Estado t√©cnico</span>
          </div>
          <div class="chart-box"><canvas id="chartStatus"></canvas></div>
        </div>
        <div class="card">
          <div class="card-head">
            <h3>Tendencia de informes</h3>
            <span class="pill soft">√öltimos 14 d√≠as</span>
          </div>
          <div class="chart-box"><canvas id="chartTrend"></canvas></div>
        </div>
        <div class="card">
          <div class="card-head">
            <h3>Top componentes con fallas</h3>
            <span class="pill soft">Alertas</span>
          </div>
          <div class="chart-box"><canvas id="chartComponents"></canvas></div>
        </div>
      </div>

      <div class="grid-3" style="margin-top: 1rem;">
        <div class="card">
          <div class="card-head">
            <h3>√öltimos informes</h3>
            <span class="pill soft">Historial r√°pido</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Fecha</th><th>Patente</th><th>Veh√≠culo</th><th>Estado</th></tr>
              </thead>
              <tbody id="lastReports"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h3>Pr√≥ximas citas</h3>
            <span class="pill soft">Agenda</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Fecha</th><th>Cliente</th><th>Patente</th><th>Estado</th></tr>
              </thead>
              <tbody id="nextAppointments"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h3>√öltimas facturas</h3>
            <span class="pill soft">Ventas</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Fecha</th><th>Cliente</th><th>Total</th><th>Pago</th></tr>
              </thead>
              <tbody id="lastInvoices"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- INFORMES -->
    <section id="reports" class="section">
      <div class="grid-2">
        <div class="card">
          <div class="card-head">
            <h3>Informes generados por el chatbot</h3>
            <span class="pill">vw_reports_full</span>
          </div>

          <div style="display:flex; gap:0.5rem; margin-bottom:0.6rem;">
            <input id="reportsSearch" class="search" placeholder="Filtrar por patente, cliente, componente, mec√°nico..." />
            <select id="reportsFilter" class="btn pill">
              <option value="all">Todos</option>
              <option value="ok">Solo OK</option>
              <option value="alert">Solo Alertas</option>
            </select>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Patente</th>
                  <th>Veh√≠culo</th>
                  <th>Cliente</th>
                  <th>Componente</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="reportsBody"></tbody>
            </table>
          </div>
          <div id="reportsEmpty" class="empty" style="display:none;">No hay informes registrados.</div>
        </div>

        <div class="card">
          <div class="card-head">
            <h3>Detalle t√©cnico seleccionado</h3>
            <span class="pill" id="repDetailLabel">Selecciona un informe</span>
          </div>

          <div id="repDetailEmpty" class="empty">Haz clic en un informe para ver el an√°lisis del chatbot.</div>

          <div id="repDetail" style="display:none; font-size:0.85rem; display:flex; flex-direction:column; gap:0.4rem;">
            <div><b>Fecha:</b> <span id="rdFecha"></span></div>
            <div><b>Cliente:</b> <span id="rdCliente"></span> ‚Äî <span id="rdTel"></span></div>
            <div><b>Veh√≠culo:</b> <span id="rdVeh"></span> ‚Äî <b>Patente:</b> <span id="rdPat"></span></div>
            <div><b>Componente:</b> <span id="rdComp"></span></div>
            <div><b>Medici√≥n:</b> <span id="rdMed"></span></div>
            <div><b>Advertencia:</b> <span id="rdAdv"></span></div>
            <div><b>Mec√°nico:</b> <span id="rdMec"></span></div>
            <hr style="border-color:var(--border); margin:0.4rem 0;">
            <div><b>An√°lisis IA:</b><br><div id="rdIA" style="color:var(--muted); line-height:1.45;"></div></div>
            <div><b>Recomendaci√≥n:</b><br><div id="rdObs" style="color:var(--muted); line-height:1.45;"></div></div>

            <div class="form-actions">
              <button class="btn pill" id="btnRDWhatsapp">Enviar resumen por WhatsApp</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CITAS -->
    <section id="appointments" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Citas y agenda del taller</h3>
          <div style="display:flex; gap:0.4rem;">
            <button class="btn primary pill" id="btnApptNew2">+ Nueva cita</button>
            <button class="btn pill" id="btnApptRefresh">Actualizar</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Inicio</th>
                <th>Cliente</th>
                <th>Patente</th>
                <th>Motivo</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="apptBody"></tbody>
          </table>
        </div>
        <div id="apptEmpty" class="empty" style="display:none;">No hay citas registradas.</div>
      </div>

      <div class="card" style="margin-top:0.8rem;">
        <div class="card-head">
          <h3>Crear cita r√°pida</h3>
          <span class="pill soft">stc_appointments</span>
        </div>

        <form id="apptForm">
          <div class="form-grid">
            <div class="field">
              <label>Tel√©fono cliente</label>
              <input id="aTel" placeholder="Ej: 56912345678 (sin +)" required />
            </div>
            <div class="field">
              <label>Nombre cliente</label>
              <input id="aNom" placeholder="Nombre del cliente" />
            </div>
            <div class="field">
              <label>Patente</label>
              <input id="aPat" placeholder="Ej: XX-YY-99" />
            </div>
            <div class="field">
              <label>Inicio</label>
              <input id="aInicio" type="datetime-local" required />
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Motivo</label>
              <textarea id="aMotivo" placeholder="Ej: Revisi√≥n general, cambio de aceite, diagn√≥stico de ruido..."></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn primary pill">Guardar cita</button>
          </div>
        </form>
      </div>
    </section>

    <!-- TIENDA -->
    <section id="store" class="section">
      <div class="grid-2">
        <div class="card">
          <div class="card-head">
            <h3>Tienda de productos / servicios</h3>
            <div style="display:flex; gap:0.4rem;">
              <button class="btn pill" id="btnProdRefresh">Actualizar</button>
            </div>
          </div>

          <input id="prodSearch" class="search" placeholder="Buscar producto o servicio..." style="margin-bottom:0.6rem;" />

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Categor√≠a</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Activo</th>
                </tr>
              </thead>
              <tbody id="prodBody"></tbody>
            </table>
          </div>
          <div id="prodEmpty" class="empty" style="display:none;">No hay productos a√∫n.</div>
        </div>

        <div class="card">
          <div class="card-head">
            <h3>Crear / editar producto</h3>
            <span class="pill soft">stc_products</span>
          </div>

          <form id="prodForm">
            <input type="hidden" id="prodId" />
            <div class="form-grid">
              <div class="field">
                <label>Nombre</label>
                <input id="pNombre" required />
              </div>
              <div class="field">
                <label>Precio</label>
                <input id="pPrecio" type="number" step="0.01" required />
              </div>
              <div class="field">
                <label>Categor√≠a</label>
                <input id="pCat" placeholder="Repuesto, mano de obra, pack, etc." />
              </div>
              <div class="field">
                <label>Stock</label>
                <input id="pStock" type="number" value="0" />
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Descripci√≥n</label>
                <textarea id="pDesc"></textarea>
              </div>
              <div class="field">
                <label>Activo</label>
                <select id="pActivo">
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button class="btn primary pill">Guardar</button>
              <button class="btn pill" type="button" id="btnProdClear">Limpiar</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- COTIZACIONES -->
    <section id="quotes" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Cotizaciones</h3>
          <span class="pill soft">stc_quotes</span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Patente</th>
                <th>Estado</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="quoteBody"></tbody>
          </table>
        </div>
        <div id="quoteEmpty" class="empty" style="display:none;">No hay cotizaciones a√∫n.</div>
      </div>
    </section>

    <!-- FACTURAS -->
    <section id="invoices" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Facturas</h3>
          <span class="pill soft">stc_invoices</span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Folio</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Pago</th>
              </tr>
            </thead>
            <tbody id="invBody"></tbody>
          </table>
        </div>
        <div id="invEmpty" class="empty" style="display:none;">No hay facturas a√∫n.</div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clients" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Clientes</h3>
          <span class="pill">stc_clients</span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Tel√©fono</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Creado</th>
              </tr>
            </thead>
            <tbody id="clientsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VEH√çCULOS -->
    <section id="vehicles" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Veh√≠culos</h3>
          <span class="pill">stc_vehicles</span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Patente</th>
                <th>Cliente</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>A√±o</th>
                <th>KM</th>
              </tr>
            </thead>
            <tbody id="vehBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CONFIGURACI√ìN -->
    <section id="settings" class="section">
      <div class="card">
        <div class="card-head">
          <h3>Configuraci√≥n del panel</h3>
          <span class="pill soft">General</span>
        </div>
        <p style="font-size:0.9rem; color:var(--muted); line-height:1.5;">
          Aqu√≠ m√°s adelante puedes manejar:
          <br>‚Ä¢ Horarios disponibles del taller (para agenda autom√°tica).
          <br>‚Ä¢ Servicios base (revisi√≥n, alineaci√≥n, cambio aceite, etc).
          <br>‚Ä¢ Datos de integraci√≥n con WhatsApp, API keys, etc.
        </p>
      </div>
    </section>

  </main>
</div>

<script>
  /* =========================
     CONFIGURACI√ìN SUPABASE
     ========================= */
  const SUPABASE_URL = "https://nyyzuqykkrlznvtmaxrm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXp1cXlra3Jsem52dG1heHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTQwMTMsImV4cCI6MjA3ODk5MDAxM30.LCVgOYa_7T-fBclBte9asGD-EGZIDShtNZcoNF5e2CM";

  const sb = (SUPABASE_URL.includes("TU-PROYECTO"))
    ? null
    : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const DEFAULT_WSP_PHONE = "56912345678"; // c√°mbialo por el del taller

  function buildWhatsappUrl(msg, tel) {
    const p = (tel || DEFAULT_WSP_PHONE).replace(/[+ ]/g, "");
    return `https://wa.me/${p}?text=${encodeURIComponent(msg)}`;
  }

  document.getElementById("globalWspBtn").href = buildWhatsappUrl(
    "Hola, quiero agendar una cita o consultar por un diagn√≥stico con el chatbot de Mec√°nica CataRomero."
  );

  /* =========================
     TEMA OSCURO / CLARO
     ========================= */
  const themeSwitch = document.getElementById("themeSwitch");
  const root = document.documentElement;

  function applyTheme(theme) {
    root.setAttribute("data-theme", theme);
    if (theme === "dark") {
      themeSwitch.checked = true;
    } else {
      themeSwitch.checked = false;
    }
    localStorage.setItem("mcataromero_theme", theme);
  }

  const storedTheme = localStorage.getItem("mcataromero_theme") || "dark";
  applyTheme(storedTheme);

  themeSwitch.addEventListener("change", () => {
    applyTheme(themeSwitch.checked ? "dark" : "light");
  });

  /* =========================
     NAV SECCIONES
     ========================= */
  const navBtns = [...document.querySelectorAll(".nav button")];
  const sections = [...document.querySelectorAll(".section")];

  navBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      navBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.section;
      sections.forEach(s => s.classList.toggle("visible", s.id === id));
    });
  });

  /* =========================
     HELPERS
     ========================= */
  const UI = {
    money(n) {
      return "$" + Number(n || 0).toLocaleString("es-CL");
    },
    fmtDate(ts) {
      if (!ts) return "-";
      return new Date(ts).toLocaleString("es-CL");
    }
  };

  /* =========================
     ESTADO GLOBAL
     ========================= */
  const state = {
    reports: [],
    appointments: [],
    products: [],
    quotes: [],
    invoices: [],
    clients: [],
    vehicles: [],
  };

  /* =========================
     CARGA DE DATOS DESDE SUPABASE
     ========================= */
 function normalizeEvRegistro(r) {
  // Ajusta aqu√≠ si tus columnas tienen otros nombres
  return {
    id: r.id,
    created_at: r.created_at || r.fecha || r.timestamp,

    // cliente
    cliente_nombre: r.nombre_cliente || r.cliente || r.nombre || null,
    cliente_telefono: r.telefono || r.phone || r.whatsapp || null,

    // veh√≠culo
    patente: r.patente || r.ppu || r.placa || null,
    marca: r.marca || r.brand || null,
    modelo: r.modelo || r.model || null,
    ano: r.ano || r.anio || null,
    motor: r.motor || null,
    kilometraje: r.kilometraje || r.km || null,

    // informe t√©cnico
    mecanico: r.mecanico || r.operador || null,
    componente: r.componente || r.parte || null,
    medida_componente: r.medida_componente || r.medida || r.valor || null,
    advertencia: r.advertencia || r.estado || r.warning || null,
    analisis_ia: r.analisis_ia || r.ia || r.analisis || null,
    obs_rec: r.obs_rec || r.recomendacion || r.obs || null,
  };
}

  async function loadBaseData() {
    if (!sb) {
      alert("Configura tu SUPABASE_URL y SUPABASE_ANON_KEY en el HTML.");
      return;
    }

    // clientes
    const c = await sb.from("stc_clients").select("*").order("created_at", { ascending: false });
    state.clients = c.data || [];

    // veh√≠culos
    const v = await sb.from("stc_vehicles").select("*").order("created_at", { ascending: false });
    state.vehicles = v.data || [];

    // informes (vista completa si existe, si no, stc_reports)
    // informes DESDE stc_ev_registros (tabla n8n)
const ev = await sb
  .from("stc_ev_registros")
  .select("*")
  .order("created_at", { ascending: false })
  .limit(500);

state.reports = (ev.data || []).map(normalizeEvRegistro);


    // citas
    const a = await sb.from("stc_appointments").select("*").order("fecha_inicio", { ascending: true }).limit(300);
    state.appointments = a.data || [];

    // productos
    const p = await sb.from("stc_products").select("*").order("created_at", { ascending: false });
    state.products = p.data || [];

    // cotizaciones
    const q = await sb.from("stc_quotes").select("*").order("created_at", { ascending: false }).limit(300);
    state.quotes = q.data || [];

    // facturas
    const i = await sb.from("stc_invoices").select("*").order("created_at", { ascending: false }).limit(300);
    state.invoices = i.data || [];

    renderAll();
  }

  /* =========================
     LOGICA STATUS INFORME
     ========================= */
  function computeStatus(report) {
    const adv = (report.advertencia || "").toLowerCase();
    if (!adv) return "SIN DATO";
    if (adv.includes("dentro") || adv.includes("recomendado")) return "OK";
    if (adv.includes("por encima") || adv.includes("por debajo") || adv.includes("fuera")) return "ALERTA";
    return "REVISAR";
  }

  /* =========================
     RENDER OVERVIEW (KPIs + TABLAS + GRAFICOS)
     ========================= */
  let chartStatus, chartTrend, chartComponents;

  function renderOverview() {
    const reports = state.reports;
    const ok = reports.filter(r => computeStatus(r) === "OK").length;
    const alert = reports.filter(r => computeStatus(r) === "ALERTA").length;
    const total = reports.length;

    const upcoming = state.appointments.filter(a => new Date(a.fecha_inicio) >= new Date());
    const pendingQuotes = state.quotes.filter(q => q.estado === "pendiente");
    const sales = state.invoices.reduce((sum, inv) => sum + Number(inv.total || 0), 0);

    document.getElementById("k-total").textContent = total;
    document.getElementById("k-ok").textContent = ok;
    document.getElementById("k-alert").textContent = alert;
    document.getElementById("k-appt").textContent = upcoming.length;
    document.getElementById("k-quotes").textContent = pendingQuotes.length;
    document.getElementById("k-sales").textContent = UI.money(sales);

    // √∫ltimas tablas
    const lastReportsTbody = document.getElementById("lastReports");
    lastReportsTbody.innerHTML = "";
    reports.slice(0, 8).forEach(r => {
      const st = computeStatus(r);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(r.created_at)}</td>
        <td>${r.patente || "-"}</td>
        <td>${(r.marca || "") + " " + (r.modelo || "")}</td>
        <td>${st}</td>
      `;
      lastReportsTbody.appendChild(tr);
    });

    const nextApptTbody = document.getElementById("nextAppointments");
    nextApptTbody.innerHTML = "";
    upcoming.slice(0, 8).forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(a.fecha_inicio)}</td>
        <td>${a.nombre_cliente || "-"}</td>
        <td>${a.patente || "-"}</td>
        <td>${a.estado}</td>
      `;
      nextApptTbody.appendChild(tr);
    });

    const lastInvTbody = document.getElementById("lastInvoices");
    lastInvTbody.innerHTML = "";
    state.invoices.slice(0, 8).forEach(inv => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(inv.created_at)}</td>
        <td>${inv.cliente_nombre || "-"}</td>
        <td>${UI.money(inv.total)}</td>
        <td>${inv.estado_pago}</td>
      `;
      lastInvTbody.appendChild(tr);
    });

    // gr√°ficos
    buildCharts(ok, alert, total);
  }

  function buildCharts(ok, alert, total) {
    const statusCtx = document.getElementById("chartStatus");
    const trendCtx = document.getElementById("chartTrend");
    const compCtx = document.getElementById("chartComponents");

    if (chartStatus) chartStatus.destroy();
    if (chartTrend) chartTrend.destroy();
    if (chartComponents) chartComponents.destroy();

    chartStatus = new Chart(statusCtx, {
      type: "doughnut",
      data: {
        labels: ["OK", "Alertas", "Revisar"],
        datasets: [{
          data: [ok, alert, total - ok - alert],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });

    const byDay = {};
    state.reports.forEach(r => {
      const d = new Date(r.created_at).toISOString().slice(0, 10);
      byDay[d] = (byDay[d] || 0) + 1;
    });
    const days = Object.keys(byDay).sort().slice(-14);
    const vals = days.map(d => byDay[d]);

    chartTrend = new Chart(trendCtx, {
      type: "line",
      data: {
        labels: days,
        datasets: [{
          label: "Informes",
          data: vals,
          tension: 0.35,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });

    const comp = {};
    state.reports.forEach(r => {
      if (computeStatus(r) !== "ALERTA") return;
      const key = r.componente || "Sin componente";
      comp[key] = (comp[key] || 0) + 1;
    });
    const top = Object.entries(comp).sort((a, b) => b[1] - a[1]).slice(0, 6);
    const labels = top.map(x => x[0]);
    const data = top.map(x => x[1]);

    chartComponents = new Chart(compCtx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          data,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });
  }

  /* =========================
     INFORMES
     ========================= */
  function renderReports() {
    const body = document.getElementById("reportsBody");
    const empty = document.getElementById("reportsEmpty");
    const search = (document.getElementById("reportsSearch").value || "").toLowerCase();
    const filter = document.getElementById("reportsFilter").value;

    const filtered = state.reports.filter(r => {
      const st = computeStatus(r);
      if (filter === "ok" && st !== "OK") return false;
      if (filter === "alert" && st !== "ALERTA") return false;

      if (!search) return true;
      const haystack = [
        r.patente,
        r.cliente_nombre,
        r.telefono,
        r.marca,
        r.modelo,
        r.componente,
        r.mecanico
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
      return haystack.includes(search);
    });

    body.innerHTML = "";
    empty.style.display = filtered.length ? "none" : "block";

    filtered.forEach(r => {
      const st = computeStatus(r);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(r.created_at)}</td>
        <td>${r.patente || "-"}</td>
        <td>${(r.marca || "") + " " + (r.modelo || "")}</td>
        <td>${(r.cliente_nombre || "-")}<br>${r.cliente_telefono || ""}</td>
        <td>${r.componente || "-"}</td>
        <td><span class="st ${st === "OK" ? "ok" : st === "ALERTA" ? "alert" : "rev"}">${st}</span></td>
      `;
      tr.addEventListener("click", () => showReportDetail(r));
      body.appendChild(tr);
    });
  }

  let selectedReport = null;

  function showReportDetail(r) {
    selectedReport = r;
    document.getElementById("repDetailEmpty").style.display = "none";
    document.getElementById("repDetail").style.display = "flex";
    document.getElementById("repDetailLabel").textContent = r.patente || "Informe";

    document.getElementById("rdFecha").textContent = UI.fmtDate(r.created_at);
    document.getElementById("rdCliente").textContent = r.cliente_nombre || "Sin nombre";
    document.getElementById("rdTel").textContent = r.cliente_telefono || "-";
    document.getElementById("rdVeh").textContent = `${r.marca || ""} ${r.modelo || ""} (${r.ano || "-"})`;
    document.getElementById("rdPat").textContent = r.patente || "-";
    document.getElementById("rdComp").textContent = r.componente || "-";
    document.getElementById("rdMed").textContent = r.medida_componente ?? "-";
    document.getElementById("rdAdv").textContent = r.advertencia || "-";
    document.getElementById("rdMec").textContent = r.mecanico || "-";
    document.getElementById("rdIA").textContent = r.analisis_ia || "-";
    document.getElementById("rdObs").textContent = r.obs_rec || "-";
  }

  document.getElementById("reportsSearch").addEventListener("input", renderReports);
  document.getElementById("reportsFilter").addEventListener("change", renderReports);

  document.getElementById("btnRDWhatsapp").addEventListener("click", () => {
    if (!selectedReport) return;
    const msg = `Hola, te comparto el resumen del informe del veh√≠culo patente ${selectedReport.patente || ""}:\n\nComponente: ${selectedReport.componente || ""}\nAdvertencia: ${selectedReport.advertencia || ""}\nRecomendaci√≥n: ${selectedReport.obs_rec || ""}`;
    window.open(buildWhatsappUrl(msg, selectedReport.cliente_telefono), "_blank");
  });

  /* =========================
     CITAS
     ========================= */
  function renderAppointments() {
    const body = document.getElementById("apptBody");
    const empty = document.getElementById("apptEmpty");

    body.innerHTML = "";
    empty.style.display = state.appointments.length ? "none" : "block";

    state.appointments.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(a.fecha_inicio)}</td>
        <td>${a.nombre_cliente || "-"}</td>
        <td>${a.patente || "-"}</td>
        <td>${a.motivo || "-"}</td>
        <td>${a.estado}</td>
      `;
      body.appendChild(tr);
    });

    document.getElementById("b-appointments").textContent = state.appointments.length;
  }

  document.getElementById("btnApptRefresh").addEventListener("click", async () => {
    const a = await sb.from("stc_appointments").select("*").order("fecha_inicio", { ascending: true }).limit(300);
    state.appointments = a.data || [];
    renderAppointments();
    renderOverview();
  });

  function setDefaultApptDatetime() {
    const input = document.getElementById("aInicio");
    const now = new Date();
    now.setMinutes(now.getMinutes() + 30);
    const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
    input.value = local.toISOString().slice(0, 16);
  }

  document.getElementById("btnNewAppointment").addEventListener("click", () => {
    navBtns.find(b => b.dataset.section === "appointments").click();
    setDefaultApptDatetime();
  });
  document.getElementById("btnApptNew2").addEventListener("click", setDefaultApptDatetime);

  document.getElementById("apptForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!sb) return;

    const tel = document.getElementById("aTel").value.trim();
    const nom = document.getElementById("aNom").value.trim() || null;
    const pat = document.getElementById("aPat").value.trim() || null;
    const inicio = document.getElementById("aInicio").value;
    const motivo = document.getElementById("aMotivo").value.trim() || null;

    if (!tel || !inicio) {
      alert("Tel√©fono y fecha/hora son obligatorios.");
      return;
    }

    // asegurar cliente
    let clientId = null;
    const existing = (state.clients || []).find(c => c.telefono === tel);
    if (existing) {
      clientId = existing.id;
    } else {
      const ins = await sb.from("stc_clients").insert({
        telefono: tel,
        nombre: nom,
      }).select("*").single();
      clientId = ins.data.id;
      state.clients.unshift(ins.data);
    }

    // asegurar veh√≠culo si viene patente
    let vehicleId = null;
    if (pat) {
      const existingVeh = (state.vehicles || []).find(v => v.patente === pat);
      if (existingVeh) {
        vehicleId = existingVeh.id;
      } else {
        const insVeh = await sb.from("stc_vehicles").insert({
          patente: pat,
          client_id: clientId
        }).select("*").single();
        vehicleId = insVeh.data.id;
        state.vehicles.unshift(insVeh.data);
      }
    }

    await sb.from("stc_appointments").insert({
      client_id: clientId,
      vehicle_id: vehicleId,
      fecha_inicio: new Date(inicio),
      motivo,
      estado: "agendada",
      nombre_cliente: nom,
      patente: pat
    });

    const a = await sb.from("stc_appointments").select("*").order("fecha_inicio", { ascending: true }).limit(300);
    state.appointments = a.data || [];
    document.getElementById("apptForm").reset();
    renderAppointments();
    renderOverview();

    alert("Cita creada correctamente.");
  });

  /* =========================
     PRODUCTOS
     ========================= */
  function renderProducts() {
    const body = document.getElementById("prodBody");
    const empty = document.getElementById("prodEmpty");
    const q = (document.getElementById("prodSearch").value || "").toLowerCase();

    const filtered = state.products.filter(p => {
      if (!q) return true;
      return [p.nombre, p.categoria, p.descripcion].filter(Boolean).join(" ").toLowerCase().includes(q);
    });

    body.innerHTML = "";
    empty.style.display = filtered.length ? "none" : "block";

    filtered.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.nombre}</td>
        <td>${p.categoria || "-"}</td>
        <td>${UI.money(p.precio)}</td>
        <td>${p.stock}</td>
        <td>${p.activo ? "S√≠" : "No"}</td>
      `;
      tr.addEventListener("click", () => fillProductForm(p));
      body.appendChild(tr);
    });
  }

  function fillProductForm(p) {
    document.getElementById("prodId").value = p?.id || "";
    document.getElementById("pNombre").value = p?.nombre || "";
    document.getElementById("pPrecio").value = p?.precio || 0;
    document.getElementById("pCat").value = p?.categoria || "";
    document.getElementById("pStock").value = p?.stock || 0;
    document.getElementById("pDesc").value = p?.descripcion || "";
    document.getElementById("pActivo").value = String(!!p?.activo);
  }

  document.getElementById("btnProdClear").addEventListener("click", () => {
    document.getElementById("prodForm").reset();
    document.getElementById("prodId").value = "";
  });

  document.getElementById("prodSearch").addEventListener("input", renderProducts);
  document.getElementById("btnProdRefresh").addEventListener("click", async () => {
    const p = await sb.from("stc_products").select("*").order("created_at", { ascending: false });
    state.products = p.data || [];
    renderProducts();
  });

  document.getElementById("prodForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!sb) return;

    const id = document.getElementById("prodId").value || null;
    const payload = {
      nombre: document.getElementById("pNombre").value.trim(),
      precio: Number(document.getElementById("pPrecio").value || 0),
      categoria: document.getElementById("pCat").value.trim() || null,
      stock: Number(document.getElementById("pStock").value || 0),
      descripcion: document.getElementById("pDesc").value.trim() || null,
      activo: document.getElementById("pActivo").value === "true"
    };

    if (!payload.nombre) {
      alert("El nombre es obligatorio.");
      return;
    }

    if (!id) {
      await sb.from("stc_products").insert(payload);
    } else {
      await sb.from("stc_products").update(payload).eq("id", id);
    }

    const p = await sb.from("stc_products").select("*").order("created_at", { ascending: false });
    state.products = p.data || [];
    renderProducts();
    document.getElementById("prodForm").reset();
    document.getElementById("prodId").value = "";
    alert("Producto guardado.");
  });

  /* =========================
     COTIZACIONES / FACTURAS (solo lectura)
     ========================= */
  function renderQuotes() {
    const body = document.getElementById("quoteBody");
    const empty = document.getElementById("quoteEmpty");
    body.innerHTML = "";
    empty.style.display = state.quotes.length ? "none" : "block";

    state.quotes.forEach(q => {
      const cli = state.clients.find(c => c.id === q.client_id);
      const veh = state.vehicles.find(v => v.id === q.vehicle_id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(q.created_at)}</td>
        <td>${cli?.nombre || "-"}<br>${cli?.telefono || ""}</td>
        <td>${veh?.patente || "-"}</td>
        <td>${q.estado}</td>
        <td>${UI.money(q.total)}</td>
      `;
      body.appendChild(tr);
    });
    document.getElementById("b-quotes").textContent = state.quotes.length;
  }

  function renderInvoices() {
    const body = document.getElementById("invBody");
    const empty = document.getElementById("invEmpty");
    body.innerHTML = "";
    empty.style.display = state.invoices.length ? "none" : "block";

    state.invoices.forEach(i => {
      const cli = state.clients.find(c => c.id === i.client_id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${UI.fmtDate(i.created_at)}</td>
        <td>${i.folio || "-"}</td>
        <td>${cli?.nombre || "-"}<br>${cli?.telefono || ""}</td>
        <td>${UI.money(i.total)}</td>
        <td>${i.estado_pago}</td>
      `;
      body.appendChild(tr);
    });
    document.getElementById("b-invoices").textContent = state.invoices.length;
  }

  /* =========================
     CLIENTES Y VEH√çCULOS
     ========================= */
  function renderClients() {
    const body = document.getElementById("clientsBody");
    body.innerHTML = "";
    state.clients.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.telefono}</td>
        <td>${c.nombre || "-"}</td>
        <td>${c.email || "-"}</td>
        <td>${UI.fmtDate(c.created_at)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderVehicles() {
    const body = document.getElementById("vehBody");
    body.innerHTML = "";
    state.vehicles.forEach(v => {
      const c = state.clients.find(x => x.id === v.client_id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.patente}</td>
        <td>${c?.nombre || "-"}<br>${c?.telefono || ""}</td>
        <td>${v.marca || "-"}</td>
        <td>${v.modelo || "-"}</td>
        <td>${v.ano || "-"}</td>
        <td>${v.kilometraje || 0}</td>
      `;
      body.appendChild(tr);
    });
  }

  /* =========================
     RENDER GLOBAL
     ========================= */
  function renderAll() {
    renderOverview();
    renderReports();
    renderAppointments();
    renderProducts();
    renderQuotes();
    renderInvoices();
    renderClients();
    renderVehicles();
  }

  /* =========================
     INIT
     ========================= */
  document.addEventListener("DOMContentLoaded", () => {
    if (!sb) return;
    loadBaseData();
  });
</script>
</body>
</html>


