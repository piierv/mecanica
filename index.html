<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mec√°nica CataRomero - Panel Chatbot + Tienda</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  
  <style>
    :root{
      --bg:#0b1220;              /* modo oscuro por defecto */
      --bg-soft:#111a2e;
      --bg-card:#0f172a;
      --primary:#1e88e5;        /* azul taller */
      --primary-soft:#1e88e522;
      --accent:#ffa726;         /* naranja t√©cnico */
      --ok:#0fb77a;
      --warn:#f2b705;
      --danger:#e53935;
      --text:#e5e7eb;
      --text-muted:#9aa4b2;
      --border:#22304a;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono";
    }
    body[data-theme="light"]{
      --bg:#f7f8fb;
      --bg-soft:#eef2f9;
      --bg-card:#ffffff;
      --primary:#0f9daf;
      --primary-soft:#0f9daf22;
      --accent:#ffb347;
      --text:#1f2933;
      --text-muted:#6b7480;
      --border:#e0e4ec;
      --shadow:0 10px 30px rgba(15,40,80,.06);
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top left, rgba(30,136,229,.12), transparent 40%),
        radial-gradient(circle at bottom right, rgba(255,167,38,.10), transparent 45%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .app-layout{display:flex;min-height:100vh;}

    /* SIDEBAR */
    .sidebar{
      width:270px; background:color-mix(in oklab, var(--bg-card) 88%, transparent);
      border-right:1px solid var(--border);
      padding:1.2rem; display:flex; flex-direction:column; gap:1.2rem;
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;align-items:center;gap:.8rem;}
    .brand-logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),#38b2ac);
      display:grid;place-items:center;color:white;font-weight:900;
      box-shadow:0 8px 18px rgba(30,136,229,.35);
      letter-spacing:.08em;
    }
    .brand-title{font-weight:800;letter-spacing:.04em;}
    .brand-subtitle{font-size:.8rem;color:var(--text-muted);}

    .nav{display:flex;flex-direction:column;gap:.4rem;}
    .nav-link{
      border:none;background:transparent;text-align:left;
      padding:.7rem .85rem;border-radius:12px;font-size:.95rem;
      color:var(--text-muted);cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;
      transition:background .15s,color .15s,transform .04s;
    }
    .nav-link:hover{background:var(--bg-soft); color:var(--text); transform:translateY(-1px);}
    .nav-link.active{background:var(--primary-soft); color:var(--primary); font-weight:700;}
    .nav-left{display:flex;gap:.6rem;align-items:center;}
    .nav-ico{width:22px;text-align:center;font-size:1.05rem;}

    .sidebar-footer{margin-top:auto;display:flex;flex-direction:column;gap:.6rem;}
    .sidebar-note{font-size:.8rem;color:var(--text-muted);line-height:1.3;}
    .whatsapp-button{
      display:inline-flex;justify-content:center;align-items:center;
      padding:.6rem .9rem;border-radius:999px;
      text-decoration:none;background:#25d366;color:#fff;
      font-size:.9rem;font-weight:700;
      box-shadow:0 6px 14px rgba(37,211,102,.45);
    }
    .theme-toggle{
      border:1px solid var(--border); background:var(--bg-soft);
      color:var(--text); font-weight:700;
      padding:.55rem .8rem;border-radius:999px;cursor:pointer;
    }

    /* MAIN */
    .main{flex:1;padding:1.6rem 1.8rem;display:flex;flex-direction:column;gap:1.2rem;}
    .main-header{display:flex;justify-content:space-between;align-items:center;gap:1rem;}
    .main-header h1{font-size:1.35rem;}
    .subtitle{font-size:.9rem;color:var(--text-muted);}

    .user-badge{display:flex;align-items:center;gap:.6rem;}
    .user-avatar{
      width:36px;height:36px;border-radius:50%;
      background:var(--primary-soft);color:var(--primary);
      display:grid;place-items:center;font-weight:800;
    }
    .user-name{font-size:.9rem;font-weight:700;}
    .user-role{font-size:.75rem;color:var(--text-muted);}

    .section{display:none;}
    .section.visible{display:block;}

    .card{
      background:var(--bg-card);
      border-radius:var(--radius);
      padding:1.05rem 1.2rem;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }
    .card-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:.75rem;margin-bottom:.8rem;
    }
    .card-header h2{font-size:1rem;}
    .pill{
      font-size:.75rem;padding:.2rem .6rem;border-radius:999px;
      background:var(--primary-soft);color:var(--primary);font-weight:700;
    }
    .pill-secondary{background:#4c6fff22;color:#8aa0ff;}
    .pill-ok{background:rgba(15,183,122,.12);color:var(--ok);}
    .pill-alert{background:rgba(229,57,53,.12);color:var(--danger);}

    .grid-cards{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));
      gap:1rem;margin-bottom:1rem;
    }
    .grid-main{
      display:grid;grid-template-columns:2fr 1.4fr;gap:1rem;
    }

    .kpi-card{display:flex;flex-direction:column;gap:.25rem;}
    .kpi-label{font-size:.8rem;color:var(--text-muted);}
    .kpi-value{font-size:1.6rem;font-weight:900;}
    .kpi-value.alert{color:var(--danger);}

    .toolbar{
      display:flex;justify-content:space-between;align-items:center;
      gap:.6rem;margin-bottom:.6rem;
    }
    .search-input{
      flex:1;padding:.5rem .8rem;border-radius:999px;
      border:1px solid var(--border);background:var(--bg-soft);
      font-size:.85rem;color:var(--text);
      outline:none;
    }
    .tag-filter{
      padding:.35rem .7rem;border-radius:999px;
      border:1px solid var(--border);background:var(--bg-soft);
      font-size:.78rem;cursor:pointer;color:var(--text-muted);font-weight:700;
    }
    .tag-filter.active{background:var(--primary-soft);border-color:var(--primary);color:var(--primary);}

    table{width:100%;border-collapse:collapse;font-size:.85rem;}
    th,td{
      text-align:left;padding:.55rem .45rem;border-bottom:1px solid var(--border);
      white-space:nowrap;
    }
    th{
      font-size:.78rem;text-transform:uppercase;letter-spacing:.03em;
      color:var(--text-muted);
    }
    tbody tr:hover{background:var(--bg-soft);cursor:pointer;}

    .detail{display:flex;flex-direction:column;gap:.8rem;}
    .detail-section h3{font-size:.9rem;margin-bottom:.3rem;}
    .detail-section p,.detail-list{font-size:.85rem;}
    .detail-list{list-style:none;}
    .detail-list li{padding:.3rem 0;border-bottom:1px dashed var(--border);}

    .detail-actions{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem;}
    .btn-primary,.btn-outline,.btn-danger{
      padding:.5rem .9rem;border-radius:999px;font-size:.85rem;font-weight:800;
      cursor:pointer;border:none;
    }
    .btn-primary{background:var(--primary);color:white;}
    .btn-outline{background:transparent;border:1px solid var(--primary);color:var(--primary);}
    .btn-danger{background:var(--danger);color:white;}
    .btn-outline:hover{background:var(--primary-soft);}

    /* FORM */
    .form-grid{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem;
    }
    .form-field{display:flex;flex-direction:column;gap:.3rem;}
    .form-field label{font-size:.8rem;color:var(--text-muted);font-weight:800;}
    .form-field input,.form-field textarea,.form-field select{
      border:1px solid var(--border);background:var(--bg-soft);
      padding:.5rem .7rem;border-radius:10px;color:var(--text);font-size:.9rem;outline:none;
    }
    .form-field textarea{min-height:80px;resize:vertical;}
    .form-actions{display:flex;gap:.5rem;margin-top:.8rem;}

    /* PRODUCTOS */
    .product-grid{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem;
    }
    .product-card{
      background:var(--bg-card);border:1px solid var(--border);
      border-radius:16px;box-shadow:var(--shadow);padding:.9rem;
      display:flex;flex-direction:column;gap:.6rem;
    }
    .product-img{
      width:100%;aspect-ratio:16/9;border-radius:12px;object-fit:cover;
      background:var(--bg-soft);border:1px solid var(--border);
    }
    .product-title{font-weight:900;}
    .product-meta{font-size:.8rem;color:var(--text-muted);}
    .product-price{font-weight:900;font-size:1.1rem;color:var(--accent);}
    .product-stock{font-size:.8rem;}
    .product-actions{display:flex;gap:.4rem;margin-top:auto;}

    .empty{
      font-size:.9rem;color:var(--text-muted);padding:.8rem;text-align:center;
      border:1px dashed var(--border);border-radius:12px;background:var(--bg-soft);
    }

    @media(max-width:1100px){
      .grid-cards{grid-template-columns:repeat(2,1fr);}
      .grid-main{grid-template-columns:1fr;}
      .product-grid{grid-template-columns:repeat(2,1fr);}
    }
    @media(max-width:720px){
      .app-layout{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;align-items:center;flex-wrap:wrap;}
      .nav{flex-direction:row;flex-wrap:wrap;}
      .main{padding:1rem;}
      .product-grid{grid-template-columns:1fr;}
      .form-grid{grid-template-columns:1fr;}
      .main-header{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>

<body data-theme="dark">
<div class="app-layout">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">MC</div>
      <div>
        <div class="brand-title">Mec√°nica CataRomero</div>
        <div class="brand-subtitle">Panel Chatbot + Tienda</div>
      </div>
    </div>

    <nav class="nav">
      <button class="nav-link active" data-section="dashboard">
        <span class="nav-left"><span class="nav-ico">üîß</span>Dashboard</span>
      </button>
      <button class="nav-link" data-section="clients">
        <span class="nav-left"><span class="nav-ico">üöó</span>Clientes</span>
      </button>
      <button class="nav-link" data-section="verification">
        <span class="nav-left"><span class="nav-ico">üîç</span>Buscar informe</span>
      </button>
      <button class="nav-link" data-section="store">
        <span class="nav-left"><span class="nav-ico">üõí</span>Tienda / Productos</span>
      </button>
    </nav>

    <div class="sidebar-footer">
      <p class="sidebar-note">
        Panel interno del taller. Informes y productos sincronizados con Supabase.
      </p>
      <button id="theme-toggle" class="theme-toggle">üåô / ‚òÄÔ∏è Cambiar tema</button>
      <a class="whatsapp-button" id="global-whatsapp-btn" target="_blank" rel="noopener">
        Abrir chatbot en WhatsApp
      </a>
    </div>
  </aside>

  <main class="main">
    <header class="main-header">
      <div>
        <h1>Panel de Informes y Tienda</h1>
        <p class="subtitle">Seguimiento t√©cnico y cat√°logo de repuestos/servicios.</p>
      </div>
      <div class="user-badge">
        <div class="user-avatar">S</div>
        <div>
          <div class="user-name">Supervisor Taller</div>
          <div class="user-role">Administrador</div>
        </div>
      </div>
    </header>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section visible">
      <div class="grid-cards">
        <div class="card kpi-card">
          <span class="kpi-label">Informes totales</span>
          <span class="kpi-value" id="kpi-total">0</span>
          <span class="subtitle" id="kpi-total-caption">Cargando...</span>
        </div>
        <div class="card kpi-card">
          <span class="kpi-label">Informes OK</span>
          <span class="kpi-value" id="kpi-ok">0</span>
          <span class="subtitle">Dentro de rango recomendado.</span>
        </div>
        <div class="card kpi-card">
          <span class="kpi-label">Alertas</span>
          <span class="kpi-value alert" id="kpi-alertas">0</span>
          <span class="subtitle">Requieren revisi√≥n.</span>
        </div>
        <div class="card kpi-card">
          <span class="kpi-label">Clientes √∫nicos</span>
          <span class="kpi-value" id="kpi-clientes">0</span>
          <span class="subtitle">Por tel√©fono WhatsApp.</span>
        </div>
      </div>

      <div class="grid-main">
        <div class="card">
          <div class="card-header">
            <h2>Informes recientes</h2>
            <span class="pill">√öltimos registros</span>
          </div>

          <div class="toolbar">
            <input id="search-input" class="search-input" type="text"
              placeholder="Buscar por patente, tel√©fono, chat ID, marca/modelo o mec√°nico..." />
            <button class="tag-filter active" data-filter="all">Todos</button>
            <button class="tag-filter" data-filter="ok">Solo OK</button>
            <button class="tag-filter" data-filter="alert">Solo alertas</button>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Patente</th>
                  <th>Veh√≠culo</th>
                  <th>Cliente</th>
                  <th>Mec√°nico</th>
                  <th>Estado</th>
                  <th>Medici√≥n</th>
                </tr>
              </thead>
              <tbody id="reports-body"></tbody>
            </table>
          </div>

          <div id="reports-empty" class="empty" style="display:none;margin-top:.7rem;">
            No hay informes todav√≠a.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Detalle del informe</h2>
            <span class="pill pill-secondary" id="detail-label">Selecciona un registro</span>
          </div>

          <div id="detail-placeholder">
            <p class="subtitle">Haz clic en un informe para ver el detalle t√©cnico.</p>
          </div>

          <div id="detail-content" class="detail" style="display:none;">
            <div class="detail-section">
              <h3>Datos generales</h3>
              <p><strong>Fecha:</strong> <span id="d-fecha"></span></p>
              <p><strong>Patente:</strong> <span id="d-patente"></span></p>
              <p><strong>Veh√≠culo:</strong> <span id="d-vehiculo"></span></p>
              <p><strong>Kilometraje:</strong> <span id="d-km"></span></p>
              <p><strong>Motor:</strong> <span id="d-motor"></span></p>
              <p><strong>Mec√°nico:</strong> <span id="d-mecanico"></span></p>
              <p><strong>Cliente:</strong>
                <span id="d-cliente-nombre"></span> ‚Äì
                <span id="d-cliente"></span>
              </p>
            </div>

            <div class="detail-section">
              <h3>Componente analizado</h3>
              <ul class="detail-list">
                <li><strong>Componente:</strong> <span id="d-componente"></span></li>
                <li><strong>Medici√≥n:</strong> <span id="d-medicion"></span></li>
                <li><strong>Advertencia:</strong> <span id="d-advertencia"></span></li>
                <li><strong>Estado:</strong> <span id="d-estado"></span></li>
              </ul>
            </div>

            <div class="detail-section">
              <h3>An√°lisis t√©cnico (IA)</h3>
              <p id="d-analisis"></p>
            </div>

            <div class="detail-section">
              <h3>Recomendaciones taller</h3>
              <p id="d-obs"></p>
            </div>

            <div class="detail-actions">
              <button id="btn-open-whatsapp" class="btn-outline">Abrir chat WhatsApp</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clients" class="section">
      <div class="card">
        <div class="card-header">
          <h2>Clientes</h2>
          <span class="pill">Agrupado por tel√©fono</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Tel√©fono</th>
                <th>Nombre</th>
                <th>Patentes</th>
                <th>Informes</th>
                <th>√öltimo informe</th>
                <th>√öltimo mec√°nico</th>
              </tr>
            </thead>
            <tbody id="clients-body"></tbody>
          </table>
        </div>
        <div id="clients-empty" class="empty" style="display:none;margin-top:.7rem;">
          No hay clientes todav√≠a.
        </div>
      </div>
    </section>

    <!-- BUSCAR INFORME -->
    <section id="verification" class="section">
      <div class="card">
        <div class="card-header">
          <h2>Buscar informe</h2>
          <span class="pill">Patente, tel√©fono o chat ID</span>
        </div>

        <div class="form-grid" style="margin-bottom:.8rem;">
          <div class="form-field">
            <label for="verification-code">C√≥digo</label>
            <input id="verification-code" type="text"
                   placeholder="Ej: ABCD11 / +569... / chat id" />
          </div>
          <div class="form-field" style="align-self:end;">
            <button id="btn-verify" class="btn-primary">Buscar</button>
          </div>
        </div>

        <div id="verification-result" style="display:none;">
          <h3 style="margin:.5rem 0;">Resultado</h3>
          <p><strong>Coincidencias:</strong> <span id="v-count"></span></p>
          <p><strong>√öltima fecha:</strong> <span id="v-fecha"></span></p>
          <p><strong>Veh√≠culo:</strong> <span id="v-vehiculo"></span></p>
          <p><strong>Estado:</strong> <span id="v-estado"></span></p>
          <p><strong>Resumen:</strong> <span id="v-resumen"></span></p>
        </div>

        <div id="verification-empty" class="empty">
          Ingresa un c√≥digo para buscar informes asociados.
        </div>
      </div>
    </section>

    <!-- TIENDA -->
    <section id="store" class="section">
      <div class="grid-main">
        <div class="card">
          <div class="card-header">
            <h2>Productos</h2>
            <span class="pill">Supabase: stc_products</span>
          </div>

          <div class="toolbar">
            <input id="product-search" class="search-input" type="text"
                   placeholder="Buscar por nombre, categor√≠a o marca..." />
            <button id="btn-refresh-products" class="btn-outline">Actualizar</button>
          </div>

          <div id="products-grid" class="product-grid"></div>
          <div id="products-empty" class="empty" style="display:none;margin-top:.7rem;">
            No hay productos a√∫n. Crea uno en el formulario.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 id="product-form-title">Crear producto</h2>
            <span class="pill pill-secondary">Admin tienda</span>
          </div>

          <form id="product-form">
            <input type="hidden" id="product-id" />

            <div class="form-grid">
              <div class="form-field">
                <label>Nombre</label>
                <input id="p-nombre" required placeholder="Ej: Cambio de aceite 10W40" />
              </div>

              <div class="form-field">
                <label>Precio (CLP)</label>
                <input id="p-precio" type="number" step="0.01" required />
              </div>

              <div class="form-field">
                <label>Categor√≠a</label>
                <input id="p-categoria" placeholder="Ej: Aceites / Frenos / Servicio" />
              </div>

              <div class="form-field">
                <label>Marca</label>
                <input id="p-marca" placeholder="Ej: Mobil / Bosch / Taller" />
              </div>

              <div class="form-field">
                <label>Stock</label>
                <input id="p-stock" type="number" required />
              </div>

              <div class="form-field">
                <label>Imagen URL</label>
                <input id="p-imagen" placeholder="https://..." />
              </div>

              <div class="form-field" style="grid-column:1/-1;">
                <label>Descripci√≥n</label>
                <textarea id="p-descripcion" placeholder="Detalle del producto o servicio"></textarea>
              </div>

              <div class="form-field">
                <label>Activo</label>
                <select id="p-activo">
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button class="btn-primary" type="submit" id="btn-save-product">Guardar</button>
              <button class="btn-outline" type="button" id="btn-clear-product">Limpiar</button>
              <button class="btn-danger" type="button" id="btn-delete-product" style="display:none;">Eliminar</button>
            </div>
          </form>

          <p class="subtitle" style="margin-top:.6rem;">
            Consejo: puedes usar esto para vender repuestos o ‚Äúservicios‚Äù (alineaci√≥n, scanner, mantenci√≥n, etc).
          </p>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // ==========================
  // CONFIG SUPABASE (CAMBIA ESTO)
  // ==========================
  const SUPABASE_URL = "https://nyyzuqykkrlznvtmaxrm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXp1cXlra3Jsem52dG1heHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTQwMTMsImV4cCI6MjA3ODk5MDAxM30.LCVgOYa_7T-fBclBte9asGD-EGZIDShtNZcoNF5e2CM";

  let supabaseClient = null;
  if (SUPABASE_URL.startsWith("https://") && !SUPABASE_URL.includes("Mecanica")) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  // WhatsApp bot
  const DEFAULT_WSP_PHONE = "56936239379";
  function buildWhatsappUrl(message, phoneOverride){
    const phone = (phoneOverride || DEFAULT_WSP_PHONE).replace(/[+ ]/g, "");
    return `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
  }
  const globalWhatsappBtn = document.getElementById("global-whatsapp-btn");
  if (globalWhatsappBtn){
    globalWhatsappBtn.href = buildWhatsappUrl(
      "Hola, quiero generar un informe t√©cnico con el chatbot de Mec√°nica CataRomero."
    );
  }

  // ==========================
  // UI: NAV + THEME
  // ==========================
  const navLinks = document.querySelectorAll(".nav-link");
  const sections = document.querySelectorAll(".section");
  navLinks.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.section;
      navLinks.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      sections.forEach(s=>s.classList.toggle("visible", s.id===id));
    });
  });

  const themeToggle = document.getElementById("theme-toggle");
  themeToggle.addEventListener("click", ()=>{
    const body = document.body;
    body.dataset.theme = body.dataset.theme === "dark" ? "light" : "dark";
    localStorage.setItem("mc_theme", body.dataset.theme);
  });
  const savedTheme = localStorage.getItem("mc_theme");
  if (savedTheme) document.body.dataset.theme = savedTheme;

  // ==========================
  // DASHBOARD DATA
  // ==========================
  let allReports = [];
  let filteredReports = [];
  let currentFilter = "all";

  const reportsBody = document.getElementById("reports-body");
  const reportsEmpty = document.getElementById("reports-empty");

  const kpiTotal = document.getElementById("kpi-total");
  const kpiTotalCaption = document.getElementById("kpi-total-caption");
  const kpiOk = document.getElementById("kpi-ok");
  const kpiAlertas = document.getElementById("kpi-alertas");
  const kpiClientes = document.getElementById("kpi-clientes");

  function computeStatus(report){
    const adv = (report.advertencia || "").toLowerCase();
    if (!adv) return "SIN DATO";
    if (adv.includes("dentro") || adv.includes("recomendado")) return "OK";
    if (adv.includes("por encima") || adv.includes("por debajo") || adv.includes("fuera")) return "ALERTA";
    return "REVISAR";
  }

  function renderReportsTable(){
    reportsBody.innerHTML = "";
    reportsEmpty.style.display = filteredReports.length ? "none" : "block";

    filteredReports.forEach(r=>{
      const status = computeStatus(r);
      const pillClass = status==="OK" ? "pill-ok" : (status==="ALERTA" ? "pill-alert" : "");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.fechaLocal}</td>
        <td>${r.patente || "-"}</td>
        <td>${(r.marca||"") + " " + (r.modelo||"")}</td>
        <td>${(r.cliente_nombre||"")}${r.cliente_nombre?"<br>":""}${r.cliente_telefono||"-"}</td>
        <td>${r.mecanico || "-"}</td>
        <td><span class="pill ${pillClass}">${status}</span></td>
        <td>${r.medida_componente != null ? r.medida_componente : "-"}</td>
      `;
      tr.addEventListener("click",()=>showDetail(r));
      reportsBody.appendChild(tr);
    });
  }

  function applyFilters(){
    const search = (document.getElementById("search-input").value||"").toLowerCase();

    filteredReports = allReports.filter(r=>{
      const status = computeStatus(r);
      if (currentFilter==="ok" && status!=="OK") return false;
      if (currentFilter==="alert" && status!=="ALERTA") return false;
      if (!search) return true;

      const haystack = [
        r.patente, r.cliente_telefono, r.chat_id, r.marca, r.modelo, r.mecanico
      ].filter(Boolean).join(" ").toLowerCase();

      return haystack.includes(search);
    });

    renderReportsTable();
  }

  async function loadDashboard(){
    if (!supabaseClient){
      kpiTotalCaption.textContent = "Configura Supabase para cargar datos reales.";
      return;
    }
    try{
      const { data, error } = await supabaseClient
        .from("stc_ev_registros")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(500);
      if (error) throw error;

      allReports = (data||[]).map(r=>({
        ...r,
        fechaLocal: new Date(r.created_at).toLocaleString("es-CL")
      }));

      const total = allReports.length;
      const totalOk = allReports.filter(r=>computeStatus(r)==="OK").length;
      const totalAlert = allReports.filter(r=>computeStatus(r)==="ALERTA").length;
      const clientesUnicos = new Set(allReports.map(r=>r.cliente_telefono).filter(Boolean)).size;

      kpiTotal.textContent = total;
      kpiOk.textContent = totalOk;
      kpiAlertas.textContent = totalAlert;
      kpiClientes.textContent = clientesUnicos;
      kpiTotalCaption.textContent = "Datos en tiempo real desde Supabase.";

      filteredReports = [...allReports];
      renderReportsTable();
    }catch(err){
      console.error(err);
      kpiTotalCaption.textContent = "Error cargando datos desde Supabase.";
    }
  }

  // ==========================
  // DETALLE INFORME
  // ==========================
  const detailPlaceholder = document.getElementById("detail-placeholder");
  const detailContent = document.getElementById("detail-content");
  const detailLabel = document.getElementById("detail-label");

  const dFecha = document.getElementById("d-fecha");
  const dPatente = document.getElementById("d-patente");
  const dVehiculo = document.getElementById("d-vehiculo");
  const dKm = document.getElementById("d-km");
  const dMotor = document.getElementById("d-motor");
  const dMecanico = document.getElementById("d-mecanico");
  const dClienteNombre = document.getElementById("d-cliente-nombre");
  const dCliente = document.getElementById("d-cliente");
  const dComponente = document.getElementById("d-componente");
  const dMedicion = document.getElementById("d-medicion");
  const dAdvertencia = document.getElementById("d-advertencia");
  const dEstado = document.getElementById("d-estado");
  const dAnalisis = document.getElementById("d-analisis");
  const dObs = document.getElementById("d-obs");

  let selectedReport=null;

  function showDetail(r){
    selectedReport=r;
    detailPlaceholder.style.display="none";
    detailContent.style.display="flex";
    detailLabel.textContent = r.patente || r.chat_id || "Informe";

    const status = computeStatus(r);

    dFecha.textContent = r.fechaLocal;
    dPatente.textContent = r.patente || "-";
    dVehiculo.textContent = `${r.marca||""} ${r.modelo||""} (${r.ano||"-"})`;
    dKm.textContent = r.kilometraje!=null ? `${r.kilometraje} km` : "-";
    dMotor.textContent = r.motor || "-";
    dMecanico.textContent = r.mecanico || "-";
    dClienteNombre.textContent = r.cliente_nombre || "Sin nombre";
    dCliente.textContent = r.cliente_telefono || "-";
    dComponente.textContent = r.componente || "-";
    dMedicion.textContent = r.medida_componente!=null ? r.medida_componente : "-";
    dAdvertencia.textContent = r.advertencia || "-";
    dEstado.textContent = status;
    dAnalisis.textContent = r.analisis_ia || "-";
    dObs.textContent = r.obs_rec || "-";
  }

  document.getElementById("btn-open-whatsapp").addEventListener("click", ()=>{
    if(!selectedReport) return;
    const msg = `Hola, quiero revisar el informe del veh√≠culo ${selectedReport.marca||""} ${selectedReport.modelo||""} patente ${selectedReport.patente||""}.`;
    window.open(buildWhatsappUrl(msg, selectedReport.cliente_telefono), "_blank");
  });

  // filtros
  document.getElementById("search-input").addEventListener("input", applyFilters);
  document.querySelectorAll(".tag-filter").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tag-filter").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentFilter=btn.dataset.filter;
      applyFilters();
    });
  });

  // ==========================
  // CLIENTES
  // ==========================
  const clientsBody=document.getElementById("clients-body");
  const clientsEmpty=document.getElementById("clients-empty");

  async function loadClients(){
    if(!supabaseClient) return;
    try{
      const { data, error } = await supabaseClient
        .from("stc_ev_clientes")
        .select("*")
        .order("ultimo_informe",{ascending:false});
      if(error) throw error;

      clientsBody.innerHTML="";
      clientsEmpty.style.display = (data||[]).length ? "none" : "block";

      (data||[]).forEach(c=>{
        const tr=document.createElement("tr");
        const fechaUlt=c.ultimo_informe ? new Date(c.ultimo_informe).toLocaleString("es-CL") : "-";
        const pats=(c.patentes||[]).join(", ");
        tr.innerHTML=`
          <td>${c.cliente_telefono||"-"}</td>
          <td>${c.cliente_nombre||"-"}</td>
          <td>${pats||"-"}</td>
          <td>${c.total_informes||0}</td>
          <td>${fechaUlt}</td>
          <td>${c.ultimo_mecanico||"-"}</td>
        `;
        tr.addEventListener("click",()=>{
          const input=document.getElementById("search-input");
          input.value=c.cliente_telefono||"";
          currentFilter="all";
          document.querySelectorAll(".tag-filter").forEach(b=>b.classList.remove("active"));
          document.querySelector('.tag-filter[data-filter="all"]').classList.add("active");
          applyFilters();
          document.querySelector('.nav-link[data-section="dashboard"]').click();
        });
        clientsBody.appendChild(tr);
      });
    }catch(err){
      console.error(err);
    }
  }

  // ==========================
  // BUSCAR INFORME
  // ==========================
  document.getElementById("btn-verify").addEventListener("click", ()=>{
    const code=(document.getElementById("verification-code").value||"").trim().toLowerCase();
    if(!code){ alert("Ingresa un c√≥digo de b√∫squeda."); return; }

    const result=document.getElementById("verification-result");
    const empty=document.getElementById("verification-empty");
    empty.style.display="none"; result.style.display="block";

    const matches=allReports.filter(r=>{
      const haystack=[r.patente,r.cliente_telefono,r.chat_id].filter(Boolean).join(" ").toLowerCase();
      return haystack.includes(code);
    });

    const vCount=document.getElementById("v-count");
    const vFecha=document.getElementById("v-fecha");
    const vVehiculo=document.getElementById("v-vehiculo");
    const vEstado=document.getElementById("v-estado");
    const vResumen=document.getElementById("v-resumen");

    if(matches.length===0){
      vCount.textContent="0 (sin resultados)";
      vFecha.textContent="-"; vVehiculo.textContent="-"; vEstado.textContent="-";
      vResumen.textContent="No se encontraron informes asociados.";
      return;
    }

    const last=matches[0];
    vCount.textContent=matches.length.toString();
    vFecha.textContent=last.fechaLocal;
    vVehiculo.textContent=`${last.marca||""} ${last.modelo||""} (${last.ano||"-"})`;
    vEstado.textContent=computeStatus(last);
    vResumen.textContent=last.analisis_ia || last.advertencia || "Informe encontrado sin an√°lisis.";
  });

  // ==========================
  // TIENDA / PRODUCTOS
  // ==========================
  let allProducts=[];
  let filteredProducts=[];

  const productsGrid=document.getElementById("products-grid");
  const productsEmpty=document.getElementById("products-empty");
  const productSearch=document.getElementById("product-search");

  function renderProducts(){
    productsGrid.innerHTML="";
    productsEmpty.style.display = filteredProducts.length ? "none" : "block";

    filteredProducts.forEach(p=>{
      const card=document.createElement("div");
      card.className="product-card";
      card.innerHTML=`
        <img class="product-img" src="${p.imagen_url||""}" onerror="this.style.display='none'">
        <div class="product-title">${p.nombre}</div>
        <div class="product-meta">${p.categoria||"-"} ‚Ä¢ ${p.marca||"-"}</div>
        <div class="product-price">$${Number(p.precio||0).toLocaleString("es-CL")}</div>
        <div class="product-stock">Stock: <b>${p.stock}</b> ${p.activo?"":"‚Ä¢ (inactivo)"}</div>
        <div class="subtitle" style="font-size:.82rem;">${p.descripcion||""}</div>
        <div class="product-actions">
          <button class="btn-outline" data-edit="${p.id}">Editar</button>
          <button class="btn-danger" data-del="${p.id}">Eliminar</button>
        </div>
      `;
      productsGrid.appendChild(card);
    });

    // eventos editar / eliminar
    productsGrid.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.dataset.edit;
        const prod=allProducts.find(x=>x.id===id);
        if(prod) fillProductForm(prod);
      });
    });
    productsGrid.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id=btn.dataset.del;
        if(!confirm("¬øEliminar producto?")) return;
        await deleteProduct(id);
      });
    });
  }

  function applyProductFilter(){
    const s=(productSearch.value||"").toLowerCase();
    filteredProducts = allProducts.filter(p=>{
      if(!s) return true;
      const hay=[p.nombre,p.categoria,p.marca].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(s);
    });
    renderProducts();
  }

  async function loadProducts(){
    if(!supabaseClient) return;
    try{
      const { data, error } = await supabaseClient
        .from("stc_products")
        .select("*")
        .order("created_at",{ascending:false});
      if(error) throw error;
      allProducts=data||[];
      filteredProducts=[...allProducts];
      renderProducts();
    }catch(err){
      console.error("Error loadProducts:", err);
    }
  }

  // Form producto
  const productForm=document.getElementById("product-form");
  const productFormTitle=document.getElementById("product-form-title");
  const btnDeleteProduct=document.getElementById("btn-delete-product");
  const btnClearProduct=document.getElementById("btn-clear-product");

  function clearProductForm(){
    productForm.reset();
    document.getElementById("product-id").value="";
    productFormTitle.textContent="Crear producto";
    btnDeleteProduct.style.display="none";
  }

  function fillProductForm(p){
    document.getElementById("product-id").value=p.id;
    document.getElementById("p-nombre").value=p.nombre||"";
    document.getElementById("p-precio").value=p.precio||0;
    document.getElementById("p-categoria").value=p.categoria||"";
    document.getElementById("p-marca").value=p.marca||"";
    document.getElementById("p-stock").value=p.stock||0;
    document.getElementById("p-imagen").value=p.imagen_url||"";
    document.getElementById("p-descripcion").value=p.descripcion||"";
    document.getElementById("p-activo").value=String(!!p.activo);
    productFormTitle.textContent="Editar producto";
    btnDeleteProduct.style.display="inline-flex";
  }

  async function saveProduct(payload){
    const id=document.getElementById("product-id").value;
    if(!supabaseClient) return;

    if(!id){
      const { error } = await supabaseClient.from("stc_products").insert(payload);
      if(error) throw error;
    }else{
      const { error } = await supabaseClient.from("stc_products").update(payload).eq("id", id);
      if(error) throw error;
    }
  }

  async function deleteProduct(id){
    if(!supabaseClient) return;
    try{
      const { error } = await supabaseClient.from("stc_products").delete().eq("id", id);
      if(error) throw error;
      clearProductForm();
      await loadProducts();
    }catch(err){
      console.error("deleteProduct", err);
      alert("Error eliminando producto");
    }
  }

  productForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload={
      nombre: document.getElementById("p-nombre").value.trim(),
      precio: Number(document.getElementById("p-precio").value||0),
      categoria: document.getElementById("p-categoria").value.trim() || null,
      marca: document.getElementById("p-marca").value.trim() || null,
      stock: Number(document.getElementById("p-stock").value||0),
      imagen_url: document.getElementById("p-imagen").value.trim() || null,
      descripcion: document.getElementById("p-descripcion").value.trim() || null,
      activo: document.getElementById("p-activo").value === "true"
    };

    try{
      await saveProduct(payload);
      clearProductForm();
      await loadProducts();
      alert("Producto guardado ‚úÖ");
    }catch(err){
      console.error("saveProduct err:", err);
      alert("Error guardando producto. Revisa consola.");
    }
  });

  btnDeleteProduct.addEventListener("click", async ()=>{
    const id=document.getElementById("product-id").value;
    if(!id) return;
    if(!confirm("¬øEliminar este producto?")) return;
    await deleteProduct(id);
  });

  btnClearProduct.addEventListener("click", clearProductForm);
  productSearch.addEventListener("input", applyProductFilter);
  document.getElementById("btn-refresh-products").addEventListener("click", loadProducts);

  // ==========================
  // INIT
  // ==========================
  async function init(){
    await loadDashboard();
    await loadClients();
    await loadProducts();
  }
  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>

